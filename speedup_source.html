<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>~/develop/vispy/examples/speedup.py.html</title>
<meta name="Generator" content="Vim/7.2">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<style type="text/css">
<!--
.Constant { color: #ff6060; }
.Statement { color: #ffff00; }
.Identifier { color: #00ffff; }
.Special { color: #ff40ff; }
pre { font-family: monospace; color: #000000; background-color: #ffffff; }
body { font-family: monospace; color: #000000; background-color: #ffffff; }
.Comment { color: #8080ff; }
.PreProc { color: #ff40ff; }
-->
</style>
</head>
<body>
<pre>
<span class="Comment">#!/usr/bin/env python</span>
<span class="Comment">#</span>
<span class="Comment"># # Grouped Barchart</span>
<span class="Comment">#</span>
<span class="Comment"># A picture from a talk for my paper: It compares code generated by 2 different</span>
<span class="Comment"># algorithms and tries to demonstrate that the code improves definitely over</span>
<span class="Comment"># not using an algorithm at all and performs nearly as well as a more expensive</span>
<span class="Comment"># algorithm</span>
<span class="PreProc">import</span> vp
<span class="PreProc">import</span> sys

title = [ &quot;<span class="Constant">benchmark</span>&quot;, &quot;<span class="Constant">gcc</span>&quot;, &quot;<span class="Constant">llvm</span>&quot;, &quot;<span class="Constant">heur4</span>&quot;, &quot;<span class="Constant">prefalloc</span>&quot;, &quot;<span class="Constant">nocoal</span>&quot; ]
rows = [
    <span class="Comment"># benchmark,     gcc,    llvm, heur4, prefalloc, nocoal</span>
    [ &quot;<span class="Constant">164.gzip</span>&quot;,    119,   120,    107,  108,   118  ],
    [ &quot;<span class="Constant">175.vpr</span>&quot;,      86,    86,   91.6,  90.1,  94.4 ],
    [ &quot;<span class="Constant">176.gcc</span>&quot;,      49.2,  53.7, 53.1,  53.4,  56.3 ],
    [ &quot;<span class="Constant">181.mcf</span>&quot;,      58,    60.7, 59.3,  57.0,  59.0 ],
    [ &quot;<span class="Constant">186.crafty</span>&quot;,   63.4,  57.6, 56.5,  56.9,  59.4 ],
    [ &quot;<span class="Constant">197.parser</span>&quot;,  123,   133,  124  ,   122, 126   ],
    [ &quot;<span class="Constant">253.perlbmk</span>&quot;,  76.9,  83.9, 84.3,  87.7,  94.2 ],
    [ &quot;<span class="Constant">254.gap</span>&quot;,      57.4,  57.9, 62.7,  63.2,  66.4 ],
    [ &quot;<span class="Constant">255.vortex</span>&quot;,   94.2, 112,  101  ,   102, 105   ],
    [ &quot;<span class="Constant">256.bzip2</span>&quot;,    95.3, 101,   86.5,  86.6,  90.6 ],
    [ &quot;<span class="Constant">300.twolf</span>&quot;,   138,   137,  131  , 129,   139   ],
]

<span class="Statement">class</span> <span class="Identifier">Data</span>(object):
    <span class="Statement">pass</span>

<span class="Comment"># Preprocess data</span>
data = []
<span class="Statement">for</span> row <span class="Statement">in</span> rows:
    nocoal    = float(row[title.index(&quot;<span class="Constant">nocoal</span>&quot;)])
    prefalloc = float(row[title.index(&quot;<span class="Constant">prefalloc</span>&quot;)])
    heur4     = float(row[title.index(&quot;<span class="Constant">heur4</span>&quot;)])
    <span class="Comment"># Calculate speedup compared to nocoal</span>
    prefalloc = nocoal/prefalloc
    heur4     = nocoal/heur4

    datum = Data()
    datum.name      = row[title.index(&quot;<span class="Constant">benchmark</span>&quot;)][4:]
    datum.prefalloc = prefalloc
    datum.heur4     = heur4
    datum.nocoal    = nocoal
    <span class="Statement">if</span> datum.prefalloc &lt; datum.heur4:
        datum.high       = &quot;<span class="Constant">heur4</span>&quot;
        datum.low_value  = datum.prefalloc
        datum.high_value = datum.heur4
    <span class="Statement">else</span>:
        datum.high       = &quot;<span class="Constant">prefalloc</span>&quot;
        datum.low_value  = datum.heur4
        datum.high_value = datum.prefalloc
    datum.difference = datum.high_value - datum.low_value
    datum.delta      = datum.prefalloc - datum.heur4
    data.append(datum)

styles = {}
styles[&quot;<span class="Constant">prefalloc</span>&quot;] = &quot;<span class="Constant">fill=green!50</span>&quot;
styles[&quot;<span class="Constant">heur4</span>&quot;]     = &quot;<span class="Constant">fill=blue!30</span>&quot;
styles[&quot;<span class="Constant">nocoal</span>&quot;]    = &quot;<span class="Constant">fill=black!30</span>&quot;

<span class="Statement">def</span> <span class="Identifier">ifelse</span>(cond,true,false):
    <span class="Statement">if</span> cond:
        <span class="Statement">return</span> true
    <span class="Statement">return</span> false

<span class="Statement">def</span> <span class="Identifier">speedup_to_percent</span>(val):
    <span class="Statement">return</span> &quot;<span class="Constant">%.1f</span>&quot; % ((val - 1.0) * 100.)

<span class="Statement">def</span> <span class="Identifier">position_min_y</span>(pos1, pos2):
    <span class="Statement">if</span> pos1.y &lt; pos2.y:
        <span class="Statement">return</span> pos1
    <span class="Statement">return</span> pos2

<span class="Statement">def</span> <span class="Identifier">position_max_y</span>(pos1, pos2):
    <span class="Statement">if</span> pos1.y &gt; pos2.y:
        <span class="Statement">return</span> pos1
    <span class="Statement">return</span> pos2

bar_width = 0.5
bar_scale = 80.
bar_skip  = 0.3


vis = vp.Graphic()
vis.width  = len(data)*(bar_width*2+bar_skip) + bar_skip
vis.height = 9.75
vis.style  = &quot;<span class="Constant">draw,rounded corners=3pt</span>&quot;

<span class="Comment">#title = vis.add(vp.Label())</span>
<span class="Comment">#title.label     = &quot;Speedup in Percent&quot;</span>
<span class="Comment">#title.placement = &quot;north&quot;</span>
<span class="Comment">#title.position  = lambda: vis.anchors().north()</span>
<span class="Comment">#title.style     = &quot;font=\\huge&quot;</span>

iter = vis.add(vp.Iterate())
iter.data = data
<span class="Comment"># base position</span>
iter.base = <span class="Statement">lambda</span>: vp.Position(bar_skip + iter.index() * (bar_width*2+bar_skip), 0)

<span class="Comment"># 2 Bars for prefalloc and heur4</span>

bar0 = iter.add(vp.Rectangle())
bar0.position = iter.base
bar0.width    = bar_width
bar0.height   = <span class="Statement">lambda</span>: max(0., (iter.datum().prefalloc - 1.0) * bar_scale)
bar0.style    = styles[&quot;<span class="Constant">prefalloc</span>&quot;]

bar1 = iter.add(vp.Rectangle())
bar1.position = bar0.anchors().south_east
bar1.width    = bar_width
bar1.height   = <span class="Statement">lambda</span>: max(0., (iter.datum().heur4 - 1.0) * bar_scale)
bar1.style    = styles[&quot;<span class="Constant">heur4</span>&quot;]

<span class="Comment"># select the lower/higher one of the 2 bars</span>
iter.lower  = <span class="Statement">lambda</span>: ifelse(iter.datum().high == &quot;<span class="Constant">heur4</span>&quot;, bar0, bar1)
iter.higher = <span class="Statement">lambda</span>: ifelse(iter.datum().high == &quot;<span class="Constant">heur4</span>&quot;, bar1, bar0)

<span class="Comment"># put line into the higher bar</span>
line = iter.add(vp.Line())
line.position = <span class="Statement">lambda</span>: iter.higher().anchors().south_west().move(
        0, iter.lower().height())
line.xshift   = <span class="Statement">lambda</span>: iter.higher().width()
<span class="Comment">#line.position = lambda: iter.base().move(0,    iter.lower().height())</span>
<span class="Comment">#line.xshift   = bar_width*2</span>
line.style    = &quot;<span class="Constant">draw=white,thick</span>&quot;

<span class="Comment"># Show the absoluate value of the lower bar</span>
low_label = iter.add(vp.Label())
low_label.position  = <span class="Statement">lambda</span>: position_max_y(
        iter.lower().anchors().north(),
        iter.lower().anchors().south().move(0, .45))
low_label.placement = &quot;<span class="Constant">north</span>&quot;
low_label.style     = &quot;<span class="Constant">font=</span><span class="Special">\\</span><span class="Constant">small</span>&quot;
low_label.label     = <span class="Statement">lambda</span>: speedup_to_percent(iter.datum().low_value)

<span class="Comment"># Show the difference between low and high</span>
diff_label = iter.add(vp.Label())
diff_label.position  = <span class="Statement">lambda</span>: iter.higher().anchors().north().move(
        0, -(iter.datum().difference/2.) * bar_scale)
diff_label.placement = &quot;<span class="Constant">center</span>&quot;
diff_label.style     = &quot;<span class="Constant">font=</span><span class="Special">\\</span><span class="Constant">small</span>&quot;
diff_label.label     = <span class="Statement">lambda</span>: &quot;<span class="Constant">$\Delta %.1f$</span>&quot; % (iter.datum().difference * 100.)

<span class="Comment"># Put benchmark name below bar</span>
label = iter.add(vp.Label())
label.position  = <span class="Statement">lambda</span>: bar0.anchors().south_east().move(0, -.1)
label.placement = &quot;<span class="Constant">north</span>&quot;
label.style     = &quot;<span class="Constant">font=</span><span class="Special">\\</span><span class="Constant">small</span>&quot;
label.label     = <span class="Statement">lambda</span>: iter.datum().name

<span class="Comment"># Create a legend</span>
subfig = vis.add(vp.SubGraphics())
subfig.placement = &quot;<span class="Constant">north east</span>&quot;
subfig.position  = vis.anchors().north_east
subfig.style     = &quot;<span class="Constant">draw,rounded corners=3pt,fill=black!20</span>&quot;

label_heur4 = subfig.add(vp.Label())
label_heur4.label     = &quot;<span class="Constant">Recoloring</span>&quot;

label_prefalloc = subfig.add(vp.Label())
label_prefalloc.position  = label_heur4.anchors().south_west
label_prefalloc.placement = &quot;<span class="Constant">north west</span>&quot;
label_prefalloc.label     = &quot;<span class="Constant">Preference-Guided A.</span>&quot;

rect_heur4 = subfig.add(vp.Rectangle())
rect_heur4.placement = &quot;<span class="Constant">east</span>&quot;
rect_heur4.position  = label_heur4.anchors().west
rect_heur4.width     = 5
rect_heur4.height    = 5
rect_heur4.style     = styles[&quot;<span class="Constant">heur4</span>&quot;] + &quot;<span class="Constant">,draw,sharp corners</span>&quot;

rect_pref = subfig.add(vp.Rectangle())
rect_pref.placement = &quot;<span class="Constant">east</span>&quot;
rect_pref.position  = label_prefalloc.anchors().west
rect_pref.width     = 5
rect_pref.height    = 5
rect_pref.style     = styles[&quot;<span class="Constant">prefalloc</span>&quot;] + &quot;<span class="Constant">,draw,sharp corners</span>&quot;

<span class="Comment"># Scala</span>
scalaiter = vis.add(vp.Iterate())
scalaiter.data = <span class="Statement">lambda</span>: range(0, 13, 3)

scalaline = scalaiter.add(vp.Line())
scalaline.position = <span class="Statement">lambda</span>: vis.anchors().south_west().move(0, scalaiter.datum() * 0.8)
scalaline.xshift   = 0.2
scalaline.visible = <span class="Statement">lambda</span>: scalaiter.datum() &gt; 0

scalalabel = scalaiter.add(vp.Label())
scalalabel.placement = &quot;<span class="Constant">east</span>&quot;
scalalabel.position  = <span class="Statement">lambda</span>: scalaline.anchors().begin().move(-0.1, 0)
scalalabel.label     = <span class="Statement">lambda</span>: &quot;<span class="Constant">%s</span><span class="Special">\\</span><span class="Constant">%%</span>&quot; % scalaiter.datum()

vis.render(sys.stdout)
</pre>
</body>
</html>
